<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>snookie.online</title>
  <link rel="icon" type="image/png" href="img/favi.png">
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--background);
      color: var(--trim);
      font-family: var(--font);
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 2rem;
    }

    .icon {
      width: 160px;
      height: auto;
      border-radius: 20%;
    }

    .input {
      width: 360px;
      max-width: 88vw;
      padding: 0.75rem 1rem;
      border-radius: 999px;
      border: 4px solid var(--trim);
      background: var(--color);
      color: var(--trim);
      font-size: 1rem;
      outline: none;
      z-index: 1000;
      box-shadow: 0 8px 20px rgba(var(--shadow-rgb), 0.12);
    }

    .input::placeholder {
      color: var(--shadow);
      opacity: 0.95;
    }
    .container { overflow: visible; }

    .buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin-top: -0.9rem; /* start slightly overlapping the input */
      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
      transition: opacity 220ms ease, transform 220ms ease, margin-top 220ms ease;
    }

    .buttons.show {
      margin-top: 0.25rem; /* slide out below the input */
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .btn {
      padding: 0.45rem 0.75rem;
      border-radius: 999px;
      border: 4px solid var(--trim);
      background: var(--color);
      color: var(--trim);
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 8px 18px rgba(var(--shadow-rgb), 0.10);
    }

    .btn:active { transform: scale(0.98); }
  </style>
</head>
<body>
  <div class="container">
    <img src="img/icon.png" alt="site icon" style="margin:0 0 1rem 0;" class="icon">
    <form id="ytmp3-form" style="display:flex;flex-direction:column;gap:0.75rem;align-items:center;">
      <div style="width:100%;text-align:center;">Enter a YouTube URL and press Convert</div>
      <div style="width:100%;display:flex;gap:0.5rem;justify-content:center;">
        <div class="input-wrap" style="flex:1;max-width:520px;position:relative;margin:0 auto;">
          <input id="v" name="v" class="input" type="text" placeholder="https://www.youtube.com/watch?v=..." style="width:100%;padding-right:3.25rem;">
          <button id="convert-inline" type="submit" class="btn convert-btn" aria-label="Convert" title="Convert">â†’</button>
        </div>
      </div>
      <div style="width:100%;display:flex;flex-direction:column;gap:0.5rem;align-items:center;">
        <div></div>
        <div id="progress"><span></span></div>
        <div style="display:flex;justify-content:flex-end;gap:0.5rem"></div>
      </div>
    </form>
  </div>
  <!-- 0x0 iframe used to receive the download without opening a new tab -->
  <iframe id="dl-frame" name="dl-frame" style="width:0;height:0;border:0;display:block;visibility:hidden;position:absolute;left:-9999px;" aria-hidden="true"></iframe>

  <style>
    /* inline additions for convert button and placeholder color */
    .input-wrap { margin: 0 auto; max-width: 520px; position: relative; width: 100%; }
  .input-wrap .convert-btn { background: var(--color); border: 3px solid var(--trim); color: var(--trim); box-shadow: none; position:absolute; right:8px; top:50%; transform:translateY(-50%); width:40px; height:40px; padding:0; border-radius:999px; display:flex; align-items:center; justify-content:center; }
    .input { padding-right: 56px; box-sizing: border-box; }
    .input::placeholder { color: #a96868; opacity: 0.95; }

    /* loading gif indicator */
    #download-indicator { display:none; width:48px; height:48px; margin-top:0.5rem; }
    #download-indicator img { width:100%; height:100%; display:block; }
  </style>

    <script>
      // Enhanced submit: inline convert button, Enter support, 0x0 iframe download, and indicator
      document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('v');
        const form = document.getElementById('ytmp3-form') || document.forms[0];
          const indicator = document.createElement('img');
          indicator.id = 'download-indicator';
          indicator.src = 'img/load.gif';
          indicator.alt = 'Downloading...';
        const container = document.querySelector('.container');
        container.appendChild(indicator);

        const iframe = document.getElementById('dl-frame');

        function showIndicator() { indicator.style.display = 'block'; }
        function hideIndicator() { indicator.style.display = 'none'; }

        // Submit handler (used by both click and Enter)
        async function handleSubmit(e) {
          if (e) e.preventDefault();
          const raw = (input || {}).value || '';
          const url = raw.trim();
          const idMatch = url.match(/(?:v=|v\/|youtu\.be\/|embed\/)([a-zA-Z0-9_-]{11})/);
          if (!idMatch) {
            alert('Please enter a valid YouTube URL');
            return;
          }
          const videoId = idMatch[1];
          const localUrl = `http://localhost:3000/download?videoId=${videoId}`;

          // Use 0x0 iframe to initiate the download without opening a new tab.
          try {
            showIndicator();
            // Do a lightweight HEAD probe first so we can detect the server is reachable
            // and will respond. The server now supports HEAD and CORS.
            const fallback = setTimeout(() => { hideIndicator(); }, 10000);
            try {
              const head = await fetch(localUrl, { method: 'HEAD', mode: 'cors' });
              if (!head.ok) {
                clearTimeout(fallback);
                hideIndicator();
                alert('Server returned an error when preparing the download');
                return;
              }
              // start download and wait 1 second after server acknowledged before hiding
              clearTimeout(fallback);
              iframe.src = localUrl;
              setTimeout(() => { hideIndicator(); }, 4000);
            } catch (err) {
              clearTimeout(fallback);
              // If HEAD fails (CORS/network), still attempt to start the iframe download
              console.warn('HEAD check failed:', err);
              iframe.src = localUrl;
              setTimeout(() => { hideIndicator(); }, 1000);
            }
          } catch (err) {
            hideIndicator();
            console.error(err);
            window.open(localUrl, '_blank', 'noopener,noreferrer');
          }
        }

        // attach to form submit
        form.addEventListener('submit', handleSubmit);

        // support Enter key on input
        input.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            handleSubmit();
          }
        });
      });
    </script>
</body>
</html>